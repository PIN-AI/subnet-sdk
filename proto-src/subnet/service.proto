syntax = "proto3";
package subnet.v1;

option go_package = "subnet/proto/subnet;pb";

import "subnet/execution_report.proto";
import "subnet/validation.proto";
import "subnet/checkpoint.proto";
import "subnet/validator.proto";
import "subnet/report.proto";

// Common acknowledgment message
message Ack { 
  bool ok = 1; 
  string msg = 2; 
}

// Subnet Validator Service - handles execution reports and validation
service ValidatorService {
  // Agent submits execution report to validators
  rpc SubmitExecutionReport(ExecutionReport) returns (Receipt);

  // Agent submits multiple execution reports in batch
  rpc SubmitExecutionReportBatch(ExecutionReportBatchRequest) returns (ExecutionReportBatchResponse);

  // Checkpoint operations
  rpc GetCheckpoint(GetCheckpointRequest) returns (CheckpointHeader);
  rpc ProposeHeader(CheckpointHeader) returns (Ack);
  rpc SubmitSignature(SignatureSubmission) returns (Ack);
  rpc GetSignatures(GetCheckpointRequest) returns (stream Signature);
  rpc GetValidatorSet(GetCheckpointRequest) returns (ValidatorSet);
  
  // Double sign detection
  rpc GetDoubleSignEvidences(DoubleSignQuery) returns (stream DoubleSignEvidence);
  
  // Validation and verification
  rpc GetValidationPolicy(GetValidationPolicyRequest) returns (ValidationPolicy);
  rpc GetVerificationRecords(GetVerificationRecordsRequest) returns (stream VerificationRecord);
  rpc GetValidatorMetrics(GetValidatorMetricsRequest) returns (ValidatorMetrics);

  // Execution report queries
  rpc GetExecutionReport(GetExecutionReportRequest) returns (ExecutionReport);
  rpc ListExecutionReports(ListExecutionReportsRequest) returns (ListExecutionReportsResponse);
}

// Request messages
message GetCheckpointRequest {
  string subnet_id = 1;
  oneof by {
    uint64 epoch = 2;
    bytes cp_hash = 3;
  }
}

message GetValidationPolicyRequest {
  string intent_type = 1;  // Optional filter by intent type
}

message GetVerificationRecordsRequest {
  string intent_id = 1;  // Optional filter by intent
  string agent_id = 2;   // Optional filter by agent
  uint32 limit = 3;      // Optional limit
}

message GetValidatorMetricsRequest {
  string validator_id = 1;  // Optional specific validator
}

message DoubleSignQuery {
  string validator_id = 1; // optional
  uint64 epoch = 2;        // optional
  uint32 limit = 3;        // optional, default 100
}

message DoubleSignEvidence {
  string validator_id = 1;
  uint64 epoch = 2;
  bytes evidence = 3;      // opaque evidence blob
}

message GetExecutionReportRequest {
  string report_id = 1;  // Required: report ID
}

message ListExecutionReportsRequest {
  string intent_id = 1;  // Optional: filter by intent ID
  uint32 limit = 2;      // Optional: max number of reports to return (default: 100)
}

message ListExecutionReportsResponse {
  repeated ExecutionReportEntry reports = 1;
  uint32 total = 2;  // Total number of reports returned
}

message ExecutionReportEntry {
  string report_id = 1;
  ExecutionReport report = 2;
}

message ValidatorMetrics {
  string validator_id = 1;
  uint64 reports_verified = 2;
  uint64 checkpoints_signed = 3;
  double uptime_percentage = 4;
  uint64 last_active = 5;
}

// Batch execution report submission request
message ExecutionReportBatchRequest {
  repeated ExecutionReport reports = 1;
  string batch_id = 2;           // Optional batch identifier for idempotency
  optional bool partial_ok = 3;  // Allow partial success (default: false)
}

// Batch execution report submission response
message ExecutionReportBatchResponse {
  repeated Receipt receipts = 1;  // Per-report responses aligned with request order
  int32 success = 2;              // Number of successful submissions
  int32 failed = 3;               // Number of failed submissions
  string msg = 4;                 // Optional summary message
}
